<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit V7">
    <title>Arbeitszeit Tracker V7</title>

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --card-border: #2c2c2e;
            --text: #ffffff;
            --text-sub: #8e8e93;
            --input: #1c1c1e;
            --accent: #0A84FF;
            
            /* Kategorie Farben */
            --c-urlaub: #FF9F0A; 
            --c-stunden: #0A84FF;
            --c-krank: #FF453A;
            --c-da: #BF5AF2;
            --c-lzk: #30D158;
            --c-sonder: #64D2FF;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* Top Bar */
        header {
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: 10px;
            background-color: var(--bg);
            text-align: center;
            border-bottom: 1px solid var(--card-border);
        }
        header h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }

        /* Main Area */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* Eingabe Form */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        
        /* WICHTIG: min-width: 0 verhindert das Zusammendr√ºcken bei Flexbox */
        .input-col { flex: 1; min-width: 0; }
        
        label { display: block; color: var(--text-sub); font-size: 11px; margin-bottom: 5px; text-transform: uppercase; }
        
        /* WICHTIG: Font-Size auf 17px erh√∂ht gegen iOS Zoom */
        input, select, textarea {
            width: 100%;
            background-color: var(--input);
            border: 1px solid var(--card-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 17px; 
            box-sizing: border-box;
            -webkit-appearance: none;
            font-family: inherit;
        }

        textarea { resize: none; height: 70px; }
        
        /* Buttons */
        .btn {
            width: 100%; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 5px;
        }
        .btn-primary { background-color: var(--card-border); color: var(--accent); }
        .btn-danger { background: none; color: var(--text-sub); border: 1px solid var(--card-border); padding: 8px; font-size: 12px; }

        /* Toggle Switch */
        .toggle-container {
            display: flex; background: var(--card); border-radius: 8px; padding: 2px; margin-bottom: 15px; border: 1px solid var(--card-border);
        }
        .toggle-btn {
            flex: 1; padding: 8px; text-align: center; font-weight: 500; font-size: 13px; border-radius: 6px; transition: 0.2s; cursor: pointer;
        }
        .toggle-btn.active { background: #3a3a3c; color: #fff; }

        /* Helper */
        .hidden { display: none; }

        /* VERLAUF LISTE */
        .history-item {
            background-color: var(--card); padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #555; position: relative;
        }
        .cat-urlaub { border-left-color: var(--c-urlaub); }
        .cat-stunden { border-left-color: var(--c-stunden); }
        .cat-kindkrank { border-left-color: var(--c-krank); }
        .cat-da { border-left-color: var(--c-da); }
        .cat-lzk { border-left-color: var(--c-lzk); }
        .cat-sonder { border-left-color: var(--c-sonder); }

        .h-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .h-title { font-size: 15px; font-weight: 600; }
        .h-meta { font-size: 12px; color: var(--text-sub); margin-top: 2px;}
        .h-val { font-size: 15px; font-weight: 700; text-align: right; }
        .h-val.neg { color: #ff453a; }
        .h-val.pos { color: #30d158; }
        .h-note { margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 13px; color: #ddd; font-style: italic; }

        /* STATISTIK GRID MIT EDIT-FUNKTION */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { 
            background-color: var(--card); 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--card-border); 
            position: relative;
            cursor: pointer;
        }
        .stat-box:active { opacity: 0.7; }
        
        .stat-box h4 { margin: 0 0 5px; font-size: 11px; color: var(--text-sub); text-transform: uppercase; }
        .stat-box span { font-size: 18px; font-weight: 700; color: var(--text); }
        .unit { font-size: 12px; color: var(--text-sub); font-weight: 400; margin-left: 2px; }
        
        .edit-icon {
            position: absolute; top: 10px; right: 10px; font-size: 14px; opacity: 0.5;
        }

        /* Tools */
        .data-tools { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-border); display: flex; gap: 10px; }
        .btn-small { flex: 1; padding: 10px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); border-radius: 6px; font-size: 12px; }

        /* Navigation */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); border-top: 1px solid var(--card-border); display: flex; height: 50px; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { flex: 1; display: flex; justify-content: center; align-items: center; color: #555; font-size: 20px; }
        .nav-item.active { color: var(--accent); }
        
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

    <header>
        <h1 id="header-title">Buchen</h1>
    </header>

    <main>
        <div id="view-input" class="view active">
            
            <div class="toggle-container">
                <div class="toggle-btn active" id="btn-taken" onclick="setMode('taken')">Genommen (-)</div>
                <div class="toggle-btn" id="btn-earned" onclick="setMode('earned')">Erhalten (+)</div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>Kategorie</label>
                    <select id="inp-cat" onchange="updateForm()">
                        <option value="Urlaub">Urlaub (Tage)</option>
                        <option value="Stunden">Stunden / √úberstunden</option>
                        <option value="Kindkrank">Kindkrank (Tage)</option>
                        <option value="DA">DA Dienstausgleich</option>
                        <option value="Langzeitkonto">Langzeitkonto (Std)</option>
                        <option value="Sonderurlaub">Sonderurlaub (Tage)</option>
                    </select>
                </div>
            </div>

            <div id="section-time-range" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Datum</label><input type="date" id="date-single" onchange="autoFillTimes()"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label>Von</label><input type="time" id="time-start" value="07:00"></div>
                    <div class="input-col"><label>Bis</label><input type="time" id="time-end" value="16:30"></div>
                </div>
            </div>

            <div id="section-date-range" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Vom Tag</label><input type="date" id="date-start" onchange="calcDaysDiff()"></div>
                    <div class="input-col"><label>Bis Tag (inkl.)</label><input type="date" id="date-end" onchange="calcDaysDiff()"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label>Anzahl Tage (Mo-Fr)</label><input type="number" id="calc-days-val" value="0"></div>
                </div>
            </div>

            <div id="section-manual" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Datum</label><input type="date" id="date-manual"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label id="lbl-amount">Menge</label><input type="number" id="inp-amount" placeholder="z.B. 8" step="0.1"></div>
                </div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>Notiz</label>
                    <textarea id="inp-note" placeholder="Grund..."></textarea>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveEntry()">Buchen</button>
        </div>

        <div id="view-history" class="view">
            <div id="history-list"></div>
            <p id="no-data-msg" style="text-align:center; color:#333; margin-top:30px; display:none;">Keine Eintr√§ge.</p>
        </div>

        <div id="view-stats" class="view">
            <div style="text-align:center; margin-bottom:10px; font-size:12px; color:#666;">Tippe auf eine Box, um den Wert zu √§ndern.</div>
            <div class="stats-grid" id="stats-grid"></div>
            
            <div class="data-tools">
                <button class="btn-small" onclick="exportData()">üíæ Backup</button>
                <button class="btn-small" onclick="document.getElementById('file-upload').click()">üìÇ Laden</button>
                <input type="file" id="file-upload" style="display:none" onchange="importData(this)">
            </div>
            <div style="margin-top:20px;">
                 <button class="btn-danger" onclick="resetAll()">Alle Daten l√∂schen</button>
            </div>
        </div>
    </main>

    <nav>
        <div class="nav-item active" onclick="showView('view-input', this, 'Eingabe')">‚å®Ô∏è</div>
        <div class="nav-item" onclick="showView('view-history', this, 'Verlauf')">‚â°</div>
        <div class="nav-item" onclick="showView('view-stats', this, 'Statistik')">üìä</div>
    </nav>

    <script>
        let entries = JSON.parse(localStorage.getItem('trackData_v5')) || [];
        let mode = 'taken'; 
        const HOURS_PER_DAY = 8; 

        const SCHEDULE = {
            1: { s: "07:00", e: "17:30" }, 
            2: { s: "07:00", e: "16:30" }, 
            3: { s: "07:00", e: "15:30" }, 
            4: { s: "07:00", e: "16:30" }, 
            5: { s: "07:00", e: "11:00" }  
        };

        window.onload = function() {
            const today = new Date().toISOString().slice(0,10);
            document.getElementById('date-single').value = today;
            document.getElementById('date-start').value = today;
            document.getElementById('date-end').value = today;
            document.getElementById('date-manual').value = today;
            updateForm();
            updateUI();
        };

        function setMode(m) {
            mode = m;
            document.getElementById('btn-taken').classList.toggle('active', m === 'taken');
            document.getElementById('btn-earned').classList.toggle('active', m === 'earned');
            updateForm();
        }

        function updateForm() {
            const cat = document.getElementById('inp-cat').value;
            const cTime = document.getElementById('section-time-range');
            const cDate = document.getElementById('section-date-range');
            const cManual = document.getElementById('section-manual');
            const lblAmount = document.getElementById('lbl-amount');

            cTime.classList.add('hidden');
            cDate.classList.add('hidden');
            cManual.classList.add('hidden');

            if (mode === 'earned') {
                cManual.classList.remove('hidden');
                if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(cat)) {
                    lblAmount.innerText = "Menge (Tage)";
                } else {
                    lblAmount.innerText = "Menge (Stunden)";
                }
            } else {
                if (cat === 'Stunden' || cat === 'Langzeitkonto') {
                    cTime.classList.remove('hidden');
                    autoFillTimes();
                } else {
                    cDate.classList.remove('hidden');
                }
            }
        }

        function autoFillTimes() {
            const dateInput = document.getElementById('date-single');
            if(!dateInput.value) return;
            const dayOfWeek = new Date(dateInput.value).getDay();
            const plan = SCHEDULE[dayOfWeek];
            if(plan) {
                document.getElementById('time-start').value = plan.s;
                document.getElementById('time-end').value = plan.e;
            }
        }

        function calcDaysDiff() {
            const sStr = document.getElementById('date-start').value;
            const eStr = document.getElementById('date-end').value;
            if(!sStr || !eStr) return;
            let dStart = new Date(sStr);
            let dEnd = new Date(eStr);
            let count = 0;
            let current = new Date(dStart);
            while (current <= dEnd) {
                const day = current.getDay();
                if (day !== 0 && day !== 6) count++;
                current.setDate(current.getDate() + 1);
            }
            document.getElementById('calc-days-val').value = count;
        }

        function saveEntry() {
            const cat = document.getElementById('inp-cat').value;
            const note = document.getElementById('inp-note').value;
            let hoursValue = 0;
            let displayDate = "";
            let displayTime = ""; 

            if (!document.getElementById('section-manual').classList.contains('hidden')) {
                const val = parseFloat(document.getElementById('inp-amount').value);
                const d = document.getElementById('date-manual').value;
                if (!val || !d) { alert('Bitte Menge pr√ºfen'); return; }
                displayDate = d;
                displayTime = "Pauschal";
                if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(cat)) {
                    hoursValue = val * HOURS_PER_DAY;
                } else {
                    hoursValue = val;
                }
            } else if (!document.getElementById('section-time-range').classList.contains('hidden')) {
                const d = document.getElementById('date-single').value;
                const t1 = document.getElementById('time-start').value;
                const t2 = document.getElementById('time-end').value;
                let s = t1.split(':').map(Number);
                let e = t2.split(':').map(Number);
                let diff = (e[0]*60 + e[1]) - (s[0]*60 + s[1]);
                if(diff === 0) diff = 24 * 60; 
                if(diff < 0) diff += 1440; 
                hoursValue = diff / 60;
                displayDate = d;
                displayTime = `${t1} - ${t2}`;
            } else if (!document.getElementById('section-date-range').classList.contains('hidden')) {
                const d1 = document.getElementById('date-start').value;
                const d2 = document.getElementById('date-end').value;
                const days = parseFloat(document.getElementById('calc-days-val').value);
                if (days <= 0) { alert('0 Tage?'); return; }
                displayDate = d1; 
                if (d1 !== d2) displayDate += " bis " + d2;
                displayTime = days + " Tag(e)";
                hoursValue = days * HOURS_PER_DAY;
            }

            addEntryInternal(cat, displayDate, displayTime, hoursValue, mode, note);
            
            alert('Gespeichert');
            document.getElementById('inp-note').value = "";
            document.getElementById('inp-amount').value = "";
            updateUI();
        }

        function addEntryInternal(cat, date, timeDesc, hours, mode, note) {
            const newEntry = {
                id: Date.now(),
                cat: cat,
                date: date,
                timeDesc: timeDesc,
                hours: hours,
                mode: mode,
                note: note
            };
            entries.unshift(newEntry);
            localStorage.setItem('trackData_v5', JSON.stringify(entries));
        }

        function deleteEntry(id) {
            if(confirm("L√∂schen?")) {
                entries = entries.filter(e => e.id !== id);
                localStorage.setItem('trackData_v5', JSON.stringify(entries));
                updateUI();
            }
        }

        function adjustStat(catName, currentTotalHours, unit) {
            let newValStr = prompt(`Aktuell: ${unit === 'Tage' ? (currentTotalHours/8).toFixed(2) : currentTotalHours.toFixed(2)} ${unit}.\n\nNeuer Stand:`);
            
            if (newValStr === null) return; 
            let newVal = parseFloat(newValStr.replace(',', '.'));
            if (isNaN(newVal)) { alert("Keine g√ºltige Zahl"); return; }

            let targetHours = newVal;
            if (unit === 'Tage') targetHours = newVal * HOURS_PER_DAY;

            let diff = targetHours - currentTotalHours;
            if (diff === 0) return; 

            let mode = diff > 0 ? 'earned' : 'taken';
            let amount = Math.abs(diff);

            addEntryInternal(
                catName, 
                new Date().toISOString().slice(0,10), 
                "Korrektur", 
                amount, 
                mode, 
                "Manuelle Korrektur Statistik"
            );
            updateUI();
        }

        function updateUI() {
            renderHistory();
            renderStats();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if(entries.length === 0) document.getElementById('no-data-msg').style.display = 'block';
            else document.getElementById('no-data-msg').style.display = 'none';

            entries.forEach(e => {
                let colorClass = '';
                if(e.cat.startsWith('Urlaub')) colorClass = 'cat-urlaub';
                else if(e.cat.startsWith('Stunden')) colorClass = 'cat-stunden';
                else if(e.cat.startsWith('Kind')) colorClass = 'cat-kindkrank';
                else if(e.cat.startsWith('DA')) colorClass = 'cat-da';
                else if(e.cat.startsWith('Langzeit')) colorClass = 'cat-lzk';
                else colorClass = 'cat-sonder';

                let valClass = e.mode === 'taken' ? 'neg' : 'pos';
                let sign = e.mode === 'taken' ? '-' : '+';
                
                let displayVal = "";
                if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(e.cat)) {
                    displayVal = (e.hours / HOURS_PER_DAY).toFixed(2) + " d";
                } else {
                    displayVal = e.hours.toFixed(2) + " h";
                }

                let noteHtml = e.note ? `<div class="h-note">${e.note}</div>` : '';

                let item = `
                    <div class="history-item ${colorClass}" onclick="deleteEntry(${e.id})">
                        <div class="h-top">
                            <div>
                                <div class="h-title">${e.cat}</div>
                                <div class="h-meta">${e.date} | ${e.timeDesc}</div>
                            </div>
                            <div class="h-val ${valClass}">${sign} ${displayVal}</div>
                        </div>
                        ${noteHtml}
                    </div>
                `;
                list.innerHTML += item;
            });
        }

        function renderStats() {
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = '';

            const categories = [
                { name: 'Urlaub', unit: 'Tage' },
                { name: 'Stunden', unit: 'Std' },
                { name: 'Kindkrank', unit: 'Tage' },
                { name: 'DA', unit: 'Tage' },
                { name: 'Langzeitkonto', unit: 'Std' },
                { name: 'Sonderurlaub', unit: 'Tage' }
            ];

            categories.forEach(c => {
                let sumHours = 0;
                entries.filter(e => e.cat === c.name).forEach(e => {
                    if(e.mode === 'earned') sumHours += e.hours;
                    else sumHours -= e.hours;
                });

                let displayVal = 0;
                if(c.unit === 'Tage') {
                    displayVal = (sumHours / HOURS_PER_DAY).toFixed(2);
                } else {
                    displayVal = sumHours.toFixed(2);
                }

                let color = displayVal >= 0 ? '#fff' : '#ff453a';

                let box = document.createElement('div');
                box.className = 'stat-box';
                box.innerHTML = `
                    <div class="edit-icon">‚úé</div>
                    <h4>${c.name}</h4>
                    <span style="color:${color}">${displayVal}<span class="unit">${c.unit}</span></span>
                `;
                box.onclick = function() {
                    adjustStat(c.name, sumHours, c.unit);
                };

                grid.appendChild(box);
            });
        }

        function exportData() {
            const dataStr = JSON.stringify(entries);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "backup_v7_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        if(confirm("√úberschreiben?")) {
                            entries = json;
                            localStorage.setItem('trackData_v5', JSON.stringify(entries));
                            updateUI();
                        }
                    }
                } catch(err) { alert("Fehler beim Laden"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function resetAll() {
            if(confirm("ALLES l√∂schen?")) {
                localStorage.removeItem('trackData_v5');
                entries = [];
                updateUI();
            }
        }

        function showView(id, el, title) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('header-title').innerText = title;
        }
    </script>
</body>
</html>
