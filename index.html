<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Arbeitszeit V15">
    <title>Arbeitszeit Tracker V15</title>

    <style>
        :root {
            --bg: #000000;
            --card: #1c1c1e;
            --card-border: #2c2c2e;
            --text: #ffffff;
            --text-sub: #8e8e93;
            --input: #1c1c1e;
            --accent: #0A84FF;
            
            /* Kategorie Farben */
            --c-urlaub: #FF9F0A; 
            --c-stunden: #0A84FF;
            --c-krank: #FF453A;
            --c-da: #BF5AF2;
            --c-lzk: #30D158;
            --c-sonder: #64D2FF;

            /* Kalender Marker Farben */
            --note-pink: #FF2D55;
            --note-teal: #30B0C7;
            --note-yellow: #FFD60A;
            --note-purple: #BF5AF2;
            --note-white: #EBEBF5;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            font-size: 14px;
        }

        /* Top Bar */
        header {
            padding-top: max(10px, env(safe-area-inset-top));
            padding-bottom: 10px;
            background-color: var(--bg);
            text-align: center;
            border-bottom: 1px solid var(--card-border);
            z-index: 100;
        }
        header h1 { margin: 0; font-size: 16px; font-weight: 600; color: var(--text-sub); text-transform: uppercase; letter-spacing: 1px; }

        /* Main Area */
        main {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px;
        }

        /* Eingabe Form */
        .input-row { display: flex; gap: 10px; margin-bottom: 12px; }
        .input-col { flex: 1; min-width: 0; }
        
        label { display: block; color: var(--text-sub); font-size: 11px; margin-bottom: 5px; text-transform: uppercase; }
        
        input, select, textarea {
            width: 100%;
            background-color: var(--input);
            border: 1px solid var(--card-border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 17px; 
            box-sizing: border-box;
            -webkit-appearance: none;
            font-family: inherit;
        }

        textarea { resize: none; height: 70px; }
        
        /* Buttons */
        .btn {
            width: 100%; padding: 14px; border-radius: 8px; border: none; font-size: 16px; font-weight: 600; cursor: pointer; margin-top: 5px;
        }
        .btn-primary { background-color: var(--card-border); color: var(--accent); }
        .btn-danger { background: none; color: var(--text-sub); border: 1px solid var(--card-border); padding: 8px; font-size: 12px; }

        /* Toggle Switch */
        .toggle-container {
            display: flex; background: var(--card); border-radius: 8px; padding: 2px; margin-bottom: 15px; border: 1px solid var(--card-border);
        }
        .toggle-btn {
            flex: 1; padding: 8px; text-align: center; font-weight: 500; font-size: 13px; border-radius: 6px; transition: 0.2s; cursor: pointer;
        }
        .toggle-btn.active { background: #3a3a3c; color: #fff; }

        /* Helper */
        .hidden { display: none; }

        /* VERLAUF LISTE */
        .history-item {
            background-color: var(--card); padding: 12px 14px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #555; position: relative;
        }
        .cat-urlaub { border-left-color: var(--c-urlaub); }
        .cat-stunden { border-left-color: var(--c-stunden); }
        .cat-kindkrank { border-left-color: var(--c-krank); }
        .cat-da { border-left-color: var(--c-da); }
        .cat-lzk { border-left-color: var(--c-lzk); }
        .cat-sonder { border-left-color: var(--c-sonder); }
        .cat-termin { border-left-width: 4px; border-left-style: solid; } /* F√ºr Termine */

        .h-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .h-title { font-size: 15px; font-weight: 600; }
        .h-meta { font-size: 13px; color: var(--text-sub); margin-top: 2px;}
        .h-val { font-size: 15px; font-weight: 700; text-align: right; }
        .h-val.neg { color: #ff453a; }
        .h-val.pos { color: #30d158; }
        .h-note { margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.1); font-size: 13px; color: #ddd; font-style: italic; }

        /* STATISTIK GRID */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { 
            background-color: var(--card); 
            padding: 12px; 
            border-radius: 8px; 
            border: 1px solid var(--card-border); 
            position: relative;
            cursor: pointer;
        }
        .stat-box:active { opacity: 0.7; }
        .stat-box h4 { margin: 0 0 5px; font-size: 11px; color: var(--text-sub); text-transform: uppercase; }
        .stat-box span { font-size: 18px; font-weight: 700; color: var(--text); }
        .unit { font-size: 12px; color: var(--text-sub); font-weight: 400; margin-left: 2px; }
        .edit-icon { position: absolute; top: 10px; right: 10px; font-size: 14px; opacity: 0.5; }
        
        /* Special Boxes */
        .stat-box.summary { border-color: #555; background: #2c2c2e; cursor: default; }
        .stat-box.summary h4 { color: var(--accent); font-weight: bold; }
        
        .stat-box.full-width { grid-column: span 2; cursor: default; }
        .stat-box.full-width h4 { color: var(--accent); }
        .upcoming-list { list-style: none; padding: 0; margin: 0; }
        .upcoming-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); font-size: 14px; }
        .upcoming-item:last-child { border-bottom: none; }
        .u-date { color: var(--text-sub); font-size: 12px; width: 80px; }
        .u-name { font-weight: 600; text-align: right; flex: 1; }

        /* KALENDER STYLES */
        .year-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 18px; font-weight: bold; }
        .year-btn { background: none; border: none; color: var(--accent); font-size: 24px; cursor: pointer; padding: 0 20px; }
        
        .cal-filter-container { display: flex; gap: 5px; margin-bottom: 15px; justify-content: center; }
        .cal-filter-btn {
            padding: 6px 12px; background-color: var(--card); border: 1px solid var(--card-border); border-radius: 15px; font-size: 12px; color: var(--text-sub); cursor: pointer;
        }
        .cal-filter-btn.active { background-color: var(--accent); color: white; border-color: var(--accent); }

        .calendar-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (orientation: landscape) { .calendar-grid { grid-template-columns: 1fr 1fr 1fr; } }

        .month-card { background-color: var(--card); padding: 10px; border-radius: 8px; border: 1px solid var(--card-border); }
        .month-name { text-align: center; font-weight: 600; margin-bottom: 10px; color: var(--text-sub); text-transform: uppercase; font-size: 12px; }
        
        .days-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; }
        .day-label { font-size: 9px; color: #555; padding-bottom: 5px; }
        .day-cell { 
            aspect-ratio: 1; display: flex; justify-content: center; align-items: center; font-size: 12px; border-radius: 4px; position: relative; cursor: pointer;
        }
        .day-cell.empty { background: none; pointer-events: none; }
        
        /* Marker */
        .has-event { background-color: #333; color: white; font-weight: bold; }
        .mark-urlaub { background-color: var(--c-urlaub); color: black; }
        .mark-stunden { background-color: var(--c-stunden); color: white; }
        .mark-krank { background-color: var(--c-krank); color: white; }
        .mark-da { background-color: var(--c-da); color: white; }
        .mark-lzk { background-color: var(--c-lzk); color: black; }
        .mark-sonder { background-color: var(--c-sonder); color: black; }
        
        /* POPUP MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; justify-content: center; align-items: center;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--card); width: 85%; max-width: 400px; padding: 20px; border-radius: 16px; border: 1px solid var(--card-border); box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            max-height: 80vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px;}
        .modal-title { font-size: 18px; font-weight: 700; }
        .close-btn { background: none; border: none; font-size: 24px; color: var(--text-sub); cursor: pointer; }
        
        /* Modal Add Section */
        .modal-add-area { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; }
        .modal-add-title { font-size: 12px; color: var(--text-sub); text-transform: uppercase; margin-bottom: 8px; }
        .modal-color-row { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .modal-color-btn { width: 30px; height: 30px; border-radius: 50%; border: 2px solid transparent; cursor: pointer; }
        .modal-color-btn.selected { border-color: white; transform: scale(1.1); }

        /* Tools */
        .data-tools { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--card-border); display: flex; gap: 10px; }
        .btn-small { flex: 1; padding: 10px; background: var(--card); border: 1px solid var(--card-border); color: var(--text); border-radius: 6px; font-size: 12px; }

        /* Navigation */
        nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(0,0,0,0.9); border-top: 1px solid var(--card-border); display: flex; height: 50px; padding-bottom: env(safe-area-inset-bottom); z-index: 500; }
        .nav-item { flex: 1; display: flex; justify-content: center; align-items: center; color: #555; font-size: 20px; }
        .nav-item.active { color: var(--accent); }
        
        .view { display: none; }
        .view.active { display: block; }
    </style>
</head>
<body>

    <header>
        <h1 id="header-title">Buchen</h1>
    </header>

    <main>
        <div id="view-input" class="view active">
            <div class="toggle-container">
                <div class="toggle-btn active" id="btn-taken" onclick="setMode('taken')">Genommen (-)</div>
                <div class="toggle-btn" id="btn-earned" onclick="setMode('earned')">Erhalten (+)</div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>Kategorie</label>
                    <select id="inp-cat" onchange="updateForm()">
                        <option value="Urlaub">Urlaub (Tage)</option>
                        <option value="Stunden">Stunden / √úberstunden</option>
                        <option value="Kindkrank">Kindkrank (Tage)</option>
                        <option value="DA">DA Dienstausgleich</option>
                        <option value="Langzeitkonto">Langzeitkonto (Std)</option>
                        <option value="Sonderurlaub">Sonderurlaub (Tage)</option>
                    </select>
                </div>
            </div>

            <div id="section-time-range" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Datum</label><input type="date" id="date-single" onchange="autoFillTimes()"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label>Von</label><input type="time" id="time-start" value="07:00"></div>
                    <div class="input-col"><label>Bis</label><input type="time" id="time-end" value="16:30"></div>
                </div>
            </div>

            <div id="section-date-range" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Vom Tag</label><input type="date" id="date-start" onchange="calcDaysDiff()"></div>
                    <div class="input-col"><label>Bis Tag (inkl.)</label><input type="date" id="date-end" onchange="calcDaysDiff()"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label>Anzahl Tage</label><input type="number" id="calc-days-val" value="0"></div>
                </div>
            </div>

            <div id="section-manual" class="hidden">
                <div class="input-row">
                    <div class="input-col"><label>Datum</label><input type="date" id="date-manual"></div>
                </div>
                <div class="input-row">
                    <div class="input-col"><label id="lbl-amount">Menge</label><input type="number" id="inp-amount" placeholder="z.B. 8" step="0.1"></div>
                </div>
            </div>

            <div class="input-row">
                <div class="input-col">
                    <label>Notiz</label>
                    <textarea id="inp-note" placeholder="Grund..."></textarea>
                </div>
            </div>

            <button class="btn btn-primary" onclick="saveEntry()">Buchen</button>
        </div>

        <div id="view-calendar" class="view">
            <div class="year-selector">
                <button class="year-btn" onclick="changeYear(-1)">‚Äπ</button>
                <span id="calendar-year-display">2026</span>
                <button class="year-btn" onclick="changeYear(1)">‚Ä∫</button>
            </div>
            
            <div class="cal-filter-container">
                <div class="cal-filter-btn active" onclick="setCalFilter('all', this)">Alle</div>
                <div class="cal-filter-btn" onclick="setCalFilter('taken', this)">Genommen (-)</div>
                <div class="cal-filter-btn" onclick="setCalFilter('earned', this)">Erhalten (+)</div>
            </div>

            <div class="calendar-grid" id="calendar-root"></div>
            <div style="height: 50px;"></div>
        </div>

        <div id="view-history" class="view">
            <div id="history-list"></div>
            <p id="no-data-msg" style="text-align:center; color:#333; margin-top:30px; display:none;">Keine Eintr√§ge.</p>
        </div>

        <div id="view-stats" class="view">
            <div style="text-align:center; margin-bottom:10px; font-size:12px; color:#666;">Tippe auf eine Box (au√üer Gesamt), um den Wert zu √§ndern.</div>
            <div class="stats-grid" id="stats-grid"></div>
            
            <div class="data-tools">
                <button class="btn-small" onclick="exportData()">üíæ Backup speichern</button>
                <button class="btn-small" onclick="document.getElementById('file-upload').click()">üìÇ Backup laden</button>
                <input type="file" id="file-upload" accept=".json" style="display:none" onchange="importData(this)">
            </div>
            <div style="margin-top:20px;">
                 <button class="btn-danger" onclick="resetAll()">Alle Daten l√∂schen</button>
            </div>
        </div>
    </main>

    <div id="day-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-date-title">01.01.2026</div>
                <button class="close-btn" onclick="closeModalDirect()">√ó</button>
            </div>
            <div id="modal-body"></div>
            
            <div class="modal-add-area">
                <div class="modal-add-title">Termin / Dienst eintragen</div>
                <input type="text" id="modal-note-input" placeholder="Name (z.B. Sp√§tschicht, Zahnarzt)" style="margin-bottom:10px; font-size:14px;">
                <div class="modal-color-row">
                    <div class="modal-color-btn selected" style="background-color: var(--note-pink)" onclick="selectModalColor(this, 'pink')"></div>
                    <div class="modal-color-btn" style="background-color: var(--note-teal)" onclick="selectModalColor(this, 'teal')"></div>
                    <div class="modal-color-btn" style="background-color: var(--note-yellow)" onclick="selectModalColor(this, 'yellow')"></div>
                    <div class="modal-color-btn" style="background-color: var(--note-purple)" onclick="selectModalColor(this, 'purple')"></div>
                    <div class="modal-color-btn" style="background-color: var(--note-white)" onclick="selectModalColor(this, 'white')"></div>
                </div>
                <button class="btn btn-primary" onclick="saveModalNote()" style="padding:10px; font-size:14px;">Speichern</button>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" onclick="showView('view-input', this, 'Eingabe')">‚å®Ô∏è</div>
        <div class="nav-item" onclick="showView('view-calendar', this, 'Kalender')">üìÖ</div>
        <div class="nav-item" onclick="showView('view-history', this, 'Verlauf')">‚â°</div>
        <div class="nav-item" onclick="showView('view-stats', this, 'Statistik')">üìä</div>
    </nav>

    <script>
        let entries = JSON.parse(localStorage.getItem('trackData_v5')) || [];
        let mode = 'taken'; 
        const HOURS_PER_DAY = 8; 
        let currentCalYear = new Date().getFullYear();
        let calendarFilter = 'all';
        let modalCurrentIsoDate = null; 
        let modalSelectedColor = 'pink'; 

        const SCHEDULE = {
            1: { s: "07:00", e: "17:30" }, 
            2: { s: "07:00", e: "16:30" }, 
            3: { s: "07:00", e: "15:30" }, 
            4: { s: "07:00", e: "16:30" }, 
            5: { s: "07:00", e: "11:00" }  
        };

        const COLOR_MAP = {
            'pink': '#FF2D55',
            'teal': '#30B0C7',
            'yellow': '#FFD60A',
            'purple': '#BF5AF2',
            'white': '#EBEBF5'
        };

        window.onload = function() {
            const today = new Date().toISOString().slice(0,10);
            if(document.getElementById('date-single')) document.getElementById('date-single').value = today;
            if(document.getElementById('date-start')) document.getElementById('date-start').value = today;
            if(document.getElementById('date-end')) document.getElementById('date-end').value = today;
            if(document.getElementById('date-manual')) document.getElementById('date-manual').value = today;
            
            updateForm();
            updateUI();
        };

        function formatDateDE(isoDate) {
            if(!isoDate) return "";
            if(isoDate.includes('.') && isoDate.length === 10) return isoDate;
            const parts = isoDate.split('-');
            if(parts.length !== 3) return isoDate;
            return `${parts[2]}.${parts[1]}.${parts[0]}`; 
        }

        function formatNumber(num) {
            return Number(num.toFixed(2)).toString();
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btn-taken').classList.toggle('active', m === 'taken');
            document.getElementById('btn-earned').classList.toggle('active', m === 'earned');
            updateForm();
        }

        function updateForm() {
            const cat = document.getElementById('inp-cat').value;
            const cTime = document.getElementById('section-time-range');
            const cDate = document.getElementById('section-date-range');
            const cManual = document.getElementById('section-manual');
            const lblAmount = document.getElementById('lbl-amount');

            cTime.classList.add('hidden');
            cDate.classList.add('hidden');
            cManual.classList.add('hidden');

            if (mode === 'earned') {
                cManual.classList.remove('hidden');
                if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(cat)) {
                    lblAmount.innerText = "Menge (Tage)";
                } else {
                    lblAmount.innerText = "Menge (Stunden)";
                }
            } else {
                if (cat === 'Stunden' || cat === 'Langzeitkonto') {
                    cTime.classList.remove('hidden');
                    autoFillTimes();
                } else {
                    cDate.classList.remove('hidden');
                }
            }
        }

        function autoFillTimes() {
            const dateInput = document.getElementById('date-single');
            if(!dateInput.value) return;
            const dayOfWeek = new Date(dateInput.value).getDay();
            const plan = SCHEDULE[dayOfWeek];
            if(plan) {
                document.getElementById('time-start').value = plan.s;
                document.getElementById('time-end').value = plan.e;
            }
        }

        function calcDaysDiff() {
            const sStr = document.getElementById('date-start').value;
            const eStr = document.getElementById('date-end').value;
            if(!sStr || !eStr) return;
            let dStart = new Date(sStr);
            let dEnd = new Date(eStr);
            let count = 0;
            let current = new Date(dStart);
            while (current <= dEnd) {
                const day = current.getDay();
                if (day !== 0 && day !== 6) count++;
                current.setDate(current.getDate() + 1);
            }
            document.getElementById('calc-days-val').value = count;
        }

        function saveEntry() {
            const cat = document.getElementById('inp-cat').value;
            const note = document.getElementById('inp-note').value;
            let hoursValue = 0;
            let displayDate = "";
            let displayTime = "";
            let isoStart = "";
            let isoEnd = ""; 

            if (!document.getElementById('section-manual').classList.contains('hidden')) {
                const val = parseFloat(document.getElementById('inp-amount').value);
                const d = document.getElementById('date-manual').value;
                if (isNaN(val) || !d) { alert('Bitte Menge pr√ºfen'); return; }
                displayDate = formatDateDE(d);
                displayTime = "Pauschal";
                hoursValue = (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(cat)) ? val * HOURS_PER_DAY : val;
                isoStart = d; isoEnd = d;
            } else if (!document.getElementById('section-time-range').classList.contains('hidden')) {
                const d = document.getElementById('date-single').value;
                const t1 = document.getElementById('time-start').value;
                const t2 = document.getElementById('time-end').value;
                let s = t1.split(':').map(Number);
                let e = t2.split(':').map(Number);
                let diff = (e[0]*60 + e[1]) - (s[0]*60 + s[1]);
                if(diff === 0) diff = 24 * 60; 
                if(diff < 0) diff += 1440; 
                hoursValue = diff / 60;
                displayDate = formatDateDE(d);
                displayTime = `${t1} - ${t2}`;
                isoStart = d; isoEnd = d;
            } else if (!document.getElementById('section-date-range').classList.contains('hidden')) {
                const d1 = document.getElementById('date-start').value;
                const d2 = document.getElementById('date-end').value;
                const days = parseFloat(document.getElementById('calc-days-val').value);
                if (isNaN(days)) { alert('Tage pr√ºfen'); return; }
                displayDate = (d1 === d2) ? formatDateDE(d1) : formatDateDE(d1) + " - " + formatDateDE(d2);
                displayTime = days + " Tag(e)";
                hoursValue = days * HOURS_PER_DAY;
                isoStart = d1; isoEnd = d2;
            }

            const newEntry = {
                id: Date.now(),
                cat: cat,
                date: displayDate,
                isoStart: isoStart,
                isoEnd: isoEnd,
                timeDesc: displayTime,
                hours: hoursValue,
                mode: mode,
                note: note,
                color: null
            };

            entries.unshift(newEntry);
            localStorage.setItem('trackData_v5', JSON.stringify(entries));
            alert('Gespeichert');
            document.getElementById('inp-note').value = "";
            document.getElementById('inp-amount').value = "";
            updateUI();
        }

        function ensureIsoDates(e) {
            if(e.isoStart) return; 
            if(e.date.includes('.')) {
                if(!e.date.includes('-')) {
                    let parts = e.date.split('.');
                    if(parts.length === 3) e.isoStart = e.isoEnd = `${parts[2]}-${parts[1]}-${parts[0]}`;
                } else {
                    let dates = e.date.split(' - ');
                    if(dates.length === 2) {
                         let p1 = dates[0].split('.');
                         let p2 = dates[1].split('.');
                         e.isoStart = `${p1[2]}-${p1[1]}-${p1[0]}`;
                         e.isoEnd = `${p2[2]}-${p2[1]}-${p2[0]}`;
                    }
                }
            } else if(e.date.match(/^\d{4}-\d{2}-\d{2}$/)) {
                e.isoStart = e.isoEnd = e.date;
            }
        }

        function deleteEntry(id) {
            if(confirm("L√∂schen?")) {
                entries = entries.filter(e => e.id !== id);
                localStorage.setItem('trackData_v5', JSON.stringify(entries));
                updateUI();
                if(document.getElementById('day-modal').classList.contains('open')) {
                    openModal(modalCurrentIsoDate, getEventsForDate(modalCurrentIsoDate));
                }
            }
        }

        function adjustStat(catName, currentTotalHours, unit) {
            let newValStr = prompt(`Aktuell: ${formatNumber(unit === 'Tage' ? currentTotalHours/8 : currentTotalHours)} ${unit}.\n\nNeuer Stand:`);
            if (newValStr === null) return; 
            let newVal = parseFloat(newValStr.replace(',', '.'));
            if (isNaN(newVal)) { alert("Keine g√ºltige Zahl"); return; }
            let targetHours = newVal;
            if (unit === 'Tage') targetHours = newVal * HOURS_PER_DAY;
            let diff = targetHours - currentTotalHours;
            if (diff === 0) return; 
            let mode = diff > 0 ? 'earned' : 'taken';
            let amount = Math.abs(diff);
            
            const nowIso = new Date().toISOString().slice(0,10);
            const newEntry = {
                id: Date.now(),
                cat: catName,
                date: formatDateDE(nowIso),
                isoStart: nowIso, isoEnd: nowIso,
                timeDesc: "Korrektur",
                hours: amount,
                mode: mode,
                note: "Manuelle Korrektur Statistik"
            };
            entries.unshift(newEntry);
            localStorage.setItem('trackData_v5', JSON.stringify(entries));
            updateUI();
        }

        function updateUI() {
            renderHistory();
            renderStats();
            renderCalendar();
        }

        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            if(entries.length === 0) document.getElementById('no-data-msg').style.display = 'block';
            else document.getElementById('no-data-msg').style.display = 'none';

            entries.forEach(e => {
                let colorClass = '';
                let customStyle = '';
                
                if(e.cat === 'Termin' && e.color) {
                    customStyle = `border-left-color: ${e.color};`;
                    colorClass = 'cat-termin';
                } else {
                    if(e.cat.startsWith('Urlaub')) colorClass = 'cat-urlaub';
                    else if(e.cat.startsWith('Stunden')) colorClass = 'cat-stunden';
                    else if(e.cat.startsWith('Kind')) colorClass = 'cat-kindkrank';
                    else if(e.cat.startsWith('DA')) colorClass = 'cat-da';
                    else if(e.cat.startsWith('Langzeit')) colorClass = 'cat-lzk';
                    else colorClass = 'cat-sonder';
                }

                let valClass = e.mode === 'taken' ? 'neg' : 'pos';
                let sign = e.mode === 'taken' ? '-' : '+';
                
                let displayVal = "";
                if(e.cat === 'Termin') {
                    displayVal = "";
                    sign = "";
                } else if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(e.cat)) {
                    displayVal = formatNumber(e.hours / HOURS_PER_DAY) + " d";
                } else {
                    displayVal = formatNumber(e.hours) + " h";
                }
                
                let showDate = e.date;
                if(showDate.match(/^\d{4}-\d{2}-\d{2}$/)) showDate = formatDateDE(showDate);

                // Wenn Termin, zeigen wir den "Note" text als Titel an, weils der Name ist
                let displayTitle = e.cat;
                if(e.cat === 'Termin' && e.note) displayTitle = e.note; 

                // Wenn Termin, dann keine Note unten drunter, da sie oben steht
                let noteHtml = (e.cat !== 'Termin' && e.note) ? `<div class="h-note">${e.note}</div>` : '';

                let item = `
                    <div class="history-item ${colorClass}" style="${customStyle}" onclick="deleteEntry(${e.id})">
                        <div class="h-top">
                            <div>
                                <div class="h-title">${displayTitle}</div>
                                <div class="h-meta">${showDate} | ${e.timeDesc}</div>
                            </div>
                            <div class="h-val ${valClass}">${sign} ${displayVal}</div>
                        </div>
                        ${noteHtml}
                    </div>
                `;
                list.innerHTML += item;
            });
        }

        function renderStats() {
            const grid = document.getElementById('stats-grid');
            grid.innerHTML = '';

            // --- UPCOMING EVENTS ---
            const today = new Date().toISOString().slice(0,10);
            const upcoming = entries
                .filter(e => {
                    ensureIsoDates(e);
                    return e.cat === 'Termin' && e.isoStart >= today;
                })
                .sort((a,b) => a.isoStart.localeCompare(b.isoStart))
                .slice(0, 3); // Max 3

            let upcomingBox = document.createElement('div');
            upcomingBox.className = 'stat-box full-width';
            let listHtml = '';
            if(upcoming.length > 0) {
                upcoming.forEach(u => {
                    listHtml += `
                        <li class="upcoming-item">
                            <span class="u-date">${formatDateDE(u.isoStart).slice(0,6)}</span>
                            <span class="u-name" style="color:${u.color || 'white'}">${u.note || 'Termin'}</span>
                        </li>
                    `;
                });
            } else {
                listHtml = '<li class="upcoming-item" style="color:#666; justify-content:center;">Keine anstehenden Termine</li>';
            }
            upcomingBox.innerHTML = `<h4>Kommende Termine</h4><ul class="upcoming-list">${listHtml}</ul>`;
            grid.appendChild(upcomingBox);


            // --- SUMMEN ---
            let totalDays = 0;
            let totalHours = 0;

            entries.forEach(e => {
                let val = e.hours;
                if(e.mode === 'taken') val = -val;
                
                if(['Urlaub','DA','Sonderurlaub'].includes(e.cat)) {
                    totalDays += val;
                } else if(['Stunden', 'Langzeitkonto'].includes(e.cat)) {
                    totalHours += val;
                }
            });

            let boxDays = document.createElement('div');
            boxDays.className = 'stat-box summary';
            let colD = totalDays >= 0 ? '#fff' : '#ff453a';
            boxDays.innerHTML = `<h4>‚àë Tage (Frei)</h4><span style="color:${colD}">${formatNumber(totalDays/HOURS_PER_DAY)}<span class="unit">Gesamt</span></span>`;
            grid.appendChild(boxDays);

            let boxHours = document.createElement('div');
            boxHours.className = 'stat-box summary';
            let colH = totalHours >= 0 ? '#fff' : '#ff453a';
            boxHours.innerHTML = `<h4>‚àë Stunden</h4><span style="color:${colH}">${formatNumber(totalHours)}<span class="unit">Gesamt</span></span>`;
            grid.appendChild(boxHours);

            const categories = [
                { name: 'Urlaub', unit: 'Tage' },
                { name: 'Stunden', unit: 'Std' },
                { name: 'Kindkrank', unit: 'Tage' },
                { name: 'DA', unit: 'Tage' },
                { name: 'Langzeitkonto', unit: 'Std' },
                { name: 'Sonderurlaub', unit: 'Tage' }
            ];

            categories.forEach(c => {
                let sumHours = 0;
                entries.filter(e => e.cat === c.name).forEach(e => {
                    if(e.mode === 'earned') sumHours += e.hours;
                    else sumHours -= e.hours;
                });

                let displayVal = 0;
                if(c.unit === 'Tage') {
                    displayVal = formatNumber(sumHours / HOURS_PER_DAY);
                } else {
                    displayVal = formatNumber(sumHours);
                }

                let color = parseFloat(displayVal) >= 0 ? '#fff' : '#ff453a';

                let box = document.createElement('div');
                box.className = 'stat-box';
                box.innerHTML = `
                    <div class="edit-icon">‚úé</div>
                    <h4>${c.name}</h4>
                    <span style="color:${color}">${displayVal}<span class="unit">${c.unit}</span></span>
                `;
                box.onclick = function() { adjustStat(c.name, sumHours, c.unit); };
                grid.appendChild(box);
            });
        }

        // --- KALENDER LOGIC ---
        function changeYear(delta) {
            currentCalYear += delta;
            renderCalendar();
        }

        function setCalFilter(filter, el) {
            calendarFilter = filter;
            document.querySelectorAll('.cal-filter-btn').forEach(btn => btn.classList.remove('active'));
            el.classList.add('active');
            renderCalendar();
        }

        function getEventsForDate(isoDate) {
            return entries.filter(e => {
                ensureIsoDates(e);
                if(!e.isoStart) return false;
                const matchesDate = isoDate >= e.isoStart && isoDate <= e.isoEnd;
                
                if(calendarFilter === 'all') return matchesDate;
                if(calendarFilter === 'taken') return matchesDate && e.mode === 'taken';
                if(calendarFilter === 'earned') return matchesDate && e.mode === 'earned';
                return false;
            });
        }

        function renderCalendar() {
            document.getElementById('calendar-year-display').innerText = currentCalYear;
            const root = document.getElementById('calendar-root');
            root.innerHTML = '';
            const months = ["Jan", "Feb", "M√§r", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];

            for (let i = 0; i < 12; i++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = 'month-card';
                const title = document.createElement('div');
                title.className = 'month-name';
                title.innerText = months[i];
                monthDiv.appendChild(title);
                const daysGrid = document.createElement('div');
                daysGrid.className = 'days-grid';

                const weekDays = ["M","D","M","D","F","S","S"];
                weekDays.forEach(d => {
                    const l = document.createElement('div');
                    l.className = 'day-label';
                    l.innerText = d;
                    daysGrid.appendChild(l);
                });

                const firstDay = new Date(currentCalYear, i, 1).getDay();
                let startOffset = firstDay === 0 ? 6 : firstDay - 1;
                const daysInMonth = new Date(currentCalYear, i + 1, 0).getDate();

                for(let j=0; j<startOffset; j++) {
                    const empty = document.createElement('div');
                    empty.className = 'day-cell empty';
                    daysGrid.appendChild(empty);
                }

                for(let d=1; d<=daysInMonth; d++) {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    cell.innerText = d;

                    const mStr = (i+1).toString().padStart(2, '0');
                    const dStr = d.toString().padStart(2, '0');
                    const isoDate = `${currentCalYear}-${mStr}-${dStr}`;

                    const dayEvents = getEventsForDate(isoDate);
                    const dateObj = new Date(currentCalYear, i, d);
                    const dayOfWeek = dateObj.getDay();

                    if(dayEvents.length > 0) {
                        let primary = dayEvents[0];
                        let showMark = true;
                        
                        if(calendarFilter === 'all') {
                             if(primary.cat.startsWith('Urlaub') || primary.cat.startsWith('Sonder')) {
                                if(dayOfWeek === 0 || dayOfWeek === 6) showMark = false;
                            }
                        }
                        
                        if(showMark) {
                            cell.classList.add('has-event');
                            
                            // Custom Color hat Vorrang
                            if(primary.color) {
                                cell.style.backgroundColor = primary.color;
                                cell.style.color = 'white'; 
                                if(primary.color === '#FFD60A' || primary.color === '#EBEBF5') cell.style.color = 'black'; 
                            } else {
                                if(primary.cat.startsWith('Urlaub')) cell.classList.add('mark-urlaub');
                                else if(primary.cat.startsWith('Stunden')) cell.classList.add('mark-stunden');
                                else if(primary.cat.startsWith('Kind')) cell.classList.add('mark-krank');
                                else if(primary.cat.startsWith('DA')) cell.classList.add('mark-da');
                                else if(primary.cat.startsWith('Lang')) cell.classList.add('mark-lzk');
                                else if(primary.cat.startsWith('Sonder')) cell.classList.add('mark-sonder');
                            }
                        }
                    }

                    cell.onclick = () => openModal(isoDate, dayEvents);
                    daysGrid.appendChild(cell);
                }

                monthDiv.appendChild(daysGrid);
                root.appendChild(monthDiv);
            }
        }

        // --- POPUP LOGIC ---
        function openModal(isoDate, events) {
            modalCurrentIsoDate = isoDate;
            const title = document.getElementById('modal-date-title');
            title.innerText = formatDateDE(isoDate);
            const body = document.getElementById('modal-body');
            body.innerHTML = '';

            if(events && events.length > 0) {
                events.forEach(e => {
                    let displayVal = "";
                    let displayName = e.cat;

                    if(e.cat === 'Termin') {
                        displayVal = "";
                        displayName = e.note || "Termin";
                    } else if (['Urlaub','Kindkrank','DA','Sonderurlaub'].includes(e.cat)) {
                        displayVal = formatNumber(e.hours / HOURS_PER_DAY) + " Tag(e)";
                    } else {
                        displayVal = formatNumber(e.hours) + " Std";
                    }
                    
                    let row = document.createElement('div');
                    row.style.marginBottom = "10px";
                    row.style.borderBottom = "1px solid #333";
                    row.style.paddingBottom = "10px";
                    row.style.display = "flex";
                    row.style.justifyContent = "space-between";
                    row.style.alignItems = "center";
                    
                    let left = `
                        <div>
                            <div style="font-weight:bold; color:var(--accent); display:flex; align-items:center; gap:5px;">
                                ${displayName}
                                ${e.color ? `<div style="width:10px; height:10px; border-radius:50%; background:${e.color}; border:1px solid #fff;"></div>` : ''}
                            </div>
                            <div style="font-size:13px; color:#aaa">${e.timeDesc}</div>
                            ${displayVal ? `<div style="margin-top:2px;">${e.mode === 'taken' ? 'Genommen' : 'Erhalten'}: ${displayVal}</div>` : ''}
                            ${(e.cat !== 'Termin' && e.note) ? `<div style="font-style:italic; font-size:12px; margin-top:4px; color:#888;">"${e.note}"</div>` : ''}
                        </div>
                    `;
                    let right = `<button onclick="deleteEntry(${e.id})" style="background:none; border:none; color:#FF453A; font-size:12px;">L√∂schen</button>`;
                    
                    row.innerHTML = left + right;
                    body.appendChild(row);
                });
            } else {
                body.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">Keine Eintr√§ge f√ºr diesen Tag.</div>';
            }
            
            // Reset Modal Input
            document.getElementById('modal-note-input').value = "";
            modalSelectedColor = 'pink';
            document.querySelectorAll('.modal-color-btn').forEach(b => b.classList.remove('selected'));
            document.querySelector('.modal-color-btn').classList.add('selected'); 

            document.getElementById('day-modal').classList.add('open');
        }

        function selectModalColor(el, name) {
            modalSelectedColor = name;
            document.querySelectorAll('.modal-color-btn').forEach(b => b.classList.remove('selected'));
            el.classList.add('selected');
        }

        function saveModalNote() {
            if(!modalCurrentIsoDate) return;
            const text = document.getElementById('modal-note-input').value;
            if(!text) { alert("Bitte Namen eingeben"); return; }
            
            const colorCode = COLOR_MAP[modalSelectedColor];
            
            const newEntry = {
                id: Date.now(),
                cat: 'Termin', // Eigene Kategorie f√ºr Termine
                date: formatDateDE(modalCurrentIsoDate),
                isoStart: modalCurrentIsoDate,
                isoEnd: modalCurrentIsoDate,
                timeDesc: "Termin",
                hours: 0,
                mode: 'note',
                note: text, // Hier speichern wir den Namen
                color: colorCode
            };
            
            entries.unshift(newEntry);
            localStorage.setItem('trackData_v5', JSON.stringify(entries));
            
            // Refresh Modal content without closing
            openModal(modalCurrentIsoDate, getEventsForDate(modalCurrentIsoDate));
            updateUI(); 
        }

        function closeModal(e) {
            if (e.target.id === 'day-modal') {
                document.getElementById('day-modal').classList.remove('open');
            }
        }
        function closeModalDirect() {
            document.getElementById('day-modal').classList.remove('open');
        }

        // --- IMPORT / EXPORT ---
        function exportData() {
            const dataStr = JSON.stringify(entries);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "backup_v15_" + new Date().toISOString().slice(0,10) + ".json";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function importData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const json = JSON.parse(e.target.result);
                    if(Array.isArray(json)) {
                        if(confirm("√úberschreiben?")) {
                            entries = json;
                            localStorage.setItem('trackData_v5', JSON.stringify(entries));
                            updateUI();
                        }
                    }
                } catch(err) { alert("Fehler"); }
            };
            reader.readAsText(file);
            input.value = '';
        }

        function resetAll() {
            if(confirm("ALLES l√∂schen?")) {
                localStorage.removeItem('trackData_v5');
                entries = [];
                updateUI();
            }
        }

        function showView(id, el, title) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('header-title').innerText = title;
        }
    </script>
</body>
</html>
